# NRC7292 HaLow 드라이버 컴포넌트 상호작용

이 문서는 NRC7292 HaLow 드라이버의 주요 컴포넌트 간 상호작용에 대한 상세 다이어그램을 제공하며, 주요 컴포넌트들이 어떻게 통신하고 데이터가 시스템을 통해 어떻게 흐르는지 보여줍니다.

## 아키텍처 개요

NRC7292 드라이버는 커널과 사용자 공간 컴포넌트 간 명확한 분리를 통한 계층화된 아키텍처를 구현합니다:

```
 ┌─────────────────────────────────────────────────────────────────┐
 │                    사용자 공간 애플리케이션                       │
 ├─────────────────────────────────────────────────────────────────┤
 │  hostapd/wpa_supplicant  │  CLI Application  │  Python Scripts  │
 ├─────────────────────────────────────────────────────────────────┤
 │              Linux 커널 네트워크 스택                           │
 ├─────────────────────────────────────────────────────────────────┤
 │                     mac80211 서브시스템                         │
 └─────────────────────────────────────────────────────────────────┘
 ┌─────────────────────────────────────────────────────────────────┐
 │                   NRC7292 커널 드라이버                         │
 ├─────────────────────────────────────────────────────────────────┤
 │  mac80211 인터페이스  │  Netlink 인터페이스  │  TRX 핸들러      │
 ├─────────────────────────────────────────────────────────────────┤
 │         WIM 프로토콜 레이어 (Wireless Interface Module)          │
 ├─────────────────────────────────────────────────────────────────┤
 │                 HIF 레이어 (Hardware Interface)                  │
 ├─────────────────────────────────────────────────────────────────┤
 │             CSPI 레이어 (Custom Serial Peripheral Interface)     │
 └─────────────────────────────────────────────────────────────────┘
 ┌─────────────────────────────────────────────────────────────────┐
 │                  NRC7292 하드웨어 칩                             │
 │                    (펌웨어 + 라디오)                             │
 └─────────────────────────────────────────────────────────────────┘
```

## 1. 컴포넌트 상호작용 개요

### 핵심 컴포넌트 구조

```
┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐
│   nrc-mac80211   │◄──►│  nrc-netlink     │◄──►│   CLI App        │
│   (mac80211      │    │  (커널-사용자    │    │   (사용자 공간   │
│    인터페이스)    │    │   통신)          │    │    명령어)       │
└──────────────────┘    └──────────────────┘    └──────────────────┘
          │                        │                        │
          ▼                        ▼                        │
┌──────────────────┐    ┌──────────────────┐               │
│    nrc-trx       │◄──►│      wim.c       │               │
│  (TX/RX 패킷     │    │  (WIM 프로토콜   │               │
│    처리)         │    │    메시지)       │               │
└──────────────────┘    └──────────────────┘               │
          │                        │                        │
          ▼                        ▼                        │
┌──────────────────┐    ┌──────────────────┐               │
│     nrc-hif      │◄──►│   nrc-fw         │               │
│ (하드웨어        │    │  (펌웨어         │               │
│  인터페이스)      │    │   관리)          │               │
└──────────────────┘    └──────────────────┘               │
          │                                                 │
          ▼                                                 │
┌──────────────────┐                                       │
│  nrc-hif-cspi    │                                       │
│  (Custom SPI     │◄──────────────────────────────────────┘
│   하드웨어)      │
└──────────────────┘
          │
          ▼
┌──────────────────┐
│  NRC7292 칩      │
│   (하드웨어)     │
└──────────────────┘
```

## 2. 레이어별 상호작용

### 2.1 mac80211에서 HIF 레이어까지의 통신

```
┌─ mac80211 레이어 ────────────────────────────────────────────────────┐
│                                                                      │
│  nrc_mac_tx() ──────┐                                               │
│  nrc_mac_rx() ──────┤                                               │
│  nrc_mac_conf_tx()──┤                                               │
│  nrc_mac_sta_*() ───┘                                               │
└──────────────────────┼───────────────────────────────────────────────┘
                       │
┌─ TRX 레이어 ─────────▼───────────────────────────────────────────────┐
│                                                                      │
│  nrc_trx_handler 구조체:                                            │
│  • TX 핸들러: 인증, 암호화, 큐 관리                                  │
│  • RX 핸들러: 복호화, 패킷 처리, mac80211 전달                      │
│                                                                      │
│  플로우: TXH(handler_func, VIF_MASK) / RXH(handler_func, VIF_MASK)   │
└──────────────────────┼───────────────────────────────────────────────┘
                       │
┌─ WIM 레이어 ─────────▼───────────────────────────────────────────────┐
│                                                                      │
│  struct wim {                                                       │
│    u16 cmd/resp/event;  /* 명령/응답/이벤트 ID */                   │
│    u8  seqno;          /* 응답 매칭용 시퀀스 번호 */                 │
│    u8  n_tlvs;         /* TLV 파라미터 개수 */                      │
│    u8  payload[0];     /* TLV 파라미터 */                           │
│  }                                                                   │
│                                                                      │
│  nrc_wim_alloc_skb() ──► nrc_wim_skb_add_tlv() ──► nrc_xmit_wim_*() │
└──────────────────────┼───────────────────────────────────────────────┘
                       │
┌─ HIF 레이어 ─────────▼───────────────────────────────────────────────┐
│                                                                      │
│  struct hif {                                                       │
│    u8  type;           /* HIF_TYPE_FRAME 또는 HIF_TYPE_WIM */       │
│    u8  subtype;        /* 프레임 서브타입 또는 WIM 서브타입 */       │
│    u8  flags;          /* 제어 플래그 */                            │
│    s8  vifindex;       /* 가상 인터페이스 인덱스 */                  │
│    u16 len;            /* 페이로드 길이 */                           │
│    u16 tlv_len;        /* TLV 섹션 길이 */                          │
│    u8  payload[0];     /* 실제 데이터 */                            │
│  }                                                                   │
└──────────────────────┼───────────────────────────────────────────────┘
                       │
┌─ CSPI 레이어 ────────▼───────────────────────────────────────────────┐
│                                                                      │
│  Custom SPI 프로토콜:                                               │
│  • C_SPI_WAKE_UP (0x0)     • C_SPI_DEVICE_STATUS (0x1)             │
│  • C_SPI_EIRQ_STATUS (0x13) • C_SPI_QUEUE_STATUS (0x14)            │
│  • C_SPI_MESSAGE (0x20)     • C_SPI_TXQ_WINDOW (0x41)              │
│                                                                      │
│  타겟 디바이스와의 IRQ 기반 통신                                     │
└──────────────────────────────────────────────────────────────────────┘
```

### 2.2 데이터 플로우 시퀀스

```
TX 경로 (호스트 → 타겟):
========================

사용자 데이터
    │
    ▼ (mac80211을 통해)
nrc_mac_tx()
    │
    ▼ (TX 핸들러)
nrc_trx_handler 체인
    │ (인증, 암호화 등 처리)
    ▼
WIM 메시지 생성
    │ (nrc_wim_alloc_skb, TLV 추가)
    ▼
HIF 헤더 추가
    │ (type=HIF_TYPE_FRAME, vifindex 등)
    ▼
CSPI 전송
    │ (nrc_hif_cspi 쓰기 작업)
    ▼
NRC7292 칩


RX 경로 (타겟 → 호스트):
========================

NRC7292 칩
    │
    ▼ (CSPI IRQ)
CSPI 수신
    │ (IRQ 핸들러, 큐 상태 확인)
    ▼
HIF 처리
    │ (HIF 헤더 파싱, 타입별 라우팅)
    ▼
WIM/프레임 처리
    │ (nrc_wim_rx 또는 프레임 핸들러)
    ▼
nrc_trx_handler 체인
    │ (RX 핸들러: 복호화, 검증 등)
    ▼
nrc_mac_rx()
    │
    ▼ (mac80211로)
Linux 네트워크 스택
```

## 3. TX/RX 동작 세부사항

### 3.1 TX 동작 플로우

```
nrc_mac_tx()
    │
    ├─► VIF 및 파라미터 검증
    │
    ├─► 다음에 기반한 TX 핸들러 체인 결정:
    │   • 프레임 타입 (data/mgmt/ctrl)
    │   • VIF 타입 (STA/AP/Mesh/Monitor)
    │   • 보안 요구사항
    │
    ├─► TX 핸들러 순차 실행:
    │   ┌────────────────────────────────────────┐
    │   │ TXH(nrc_tx_frame_check, NL80211_IFTYPE_ALL) │
    │   │ TXH(nrc_tx_8023_to_80211, BIT(NL80211_IFTYPE_AP)) │
    │   │ TXH(nrc_tx_mesh_control, BIT(NL80211_IFTYPE_MESH_POINT)) │
    │   │ TXH(nrc_tx_ampdu_session, NL80211_IFTYPE_ALL) │
    │   └────────────────────────────────────────┘
    │
    ├─► WIM 프레임 메시지로 변환:
    │   • WIM SKB 할당: nrc_wim_alloc_skb()
    │   • 프레임 TLV 추가: 채널, 전송률, 전력 등
    │   • 프레임 시퀀스 번호 설정
    │
    ├─► 큐 관리:
    │   • AC 큐별 크레딧 가용성 확인
    │   • 대기 중인 프레임 카운터 업데이트
    │   • 플로우 제어 처리
    │
    └─► HIF를 통한 전송:
        • HIF 헤더 추가 (type=HIF_TYPE_FRAME)
        • CSPI 레이어로 제출
        • 완료/확인 처리
```

### 3.2 RX 동작 플로우

```
CSPI IRQ 핸들러
    │
    ├─► EIRQ 상태 레지스터 읽기
    ├─► RX 큐 상태 확인
    ├─► C_SPI_MESSAGE에서 메시지 읽기
    │
    ▼
nrc_hif_rx()
    │
    ├─► HIF 헤더 파싱
    ├─► HIF 타입별 라우팅:
    │   ├─► HIF_TYPE_FRAME → 프레임 처리
    │   ├─► HIF_TYPE_WIM → WIM 메시지 처리  
    │   └─► HIF_TYPE_LOG → 디버그 로그 처리
    │
    ▼ (프레임의 경우)
프레임 처리
    │
    ├─► radiotap 헤더 정보 추출
    ├─► RX 핸들러 체인 결정
    ├─► RX 핸들러 실행:
    │   ┌────────────────────────────────────────┐
    │   │ RXH(nrc_rx_monitor, BIT(NL80211_IFTYPE_MONITOR)) │
    │   │ RXH(nrc_rx_mesh_control, BIT(NL80211_IFTYPE_MESH_POINT)) │
    │   │ RXH(nrc_rx_sta_mgmt, NL80211_IFTYPE_ALL) │
    │   │ RXH(nrc_rx_defrag, NL80211_IFTYPE_ALL) │
    │   └────────────────────────────────────────┘
    │
    ├─► 필요시 복호화
    ├─► 통계 업데이트
    │
    └─► mac80211로 전달:
        nrc_mac_rx() → ieee80211_rx_irqsafe()
```

## 4. WIM 프로토콜 명령/응답 플로우

### 4.1 WIM 메시지 구조

```
WIM 메시지 형식:
┌─────────────────────────────────────────────────────────────┐
│                    HIF 헤더                                │
├─────────────────────────────────────────────────────────────┤
│ type=HIF_TYPE_WIM │ subtype │ flags │ vifindex │ len │ tlv_len │
├─────────────────────────────────────────────────────────────┤
│                    WIM 헤더                                │
├─────────────────────────────────────────────────────────────┤
│    cmd/resp/event    │    seqno    │    n_tlvs    │         │
├─────────────────────────────────────────────────────────────┤
│                    TLV 파라미터                            │
├─────────────────────────────────────────────────────────────┤
│  TLV1: │  타입  │ 길이   │         값                      │
│  TLV2: │  타입  │ 길이   │         값                      │
│   ...  │   ...  │   ...  │          ...                    │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 WIM 명령/응답 메커니즘

```
명령 개시:
===================

호스트 드라이버                           타겟 펌웨어
     │                                        │
     ├─► nrc_wim_alloc_skb(WIM_CMD_SET)      │
     ├─► nrc_wim_skb_add_tlv(CHANNEL)        │
     ├─► nrc_wim_skb_add_tlv(TX_POWER)       │
     ├─► nrc_xmit_wim_request()              │
     │                                       │
     │   ──── WIM 요청 (seqno=N) ────────────►│
     │                                       │ 명령 처리
     │                                       │ 설정 업데이트
     │                                       │
     │◄──── WIM 응답 (seqno=N) ──────────    │
     │                                       │
     ├─► 시퀀스 번호 매칭                    │
     ├─► 응답 TLV 처리                      │
     └─► 작업 완료                          │

동기 명령 (대기 포함):
===============================

nrc_xmit_wim_request_wait()
     │
     ├─► WIM 요청 전송
     ├─► wait_for_completion_timeout(&nw->wim_responded)
     │   (응답 또는 타임아웃까지 블록)
     │
     └─► 응답 SKB 반환 또는 타임아웃 에러

이벤트 처리:
================

타겟 펌웨어                       호스트 드라이버
     │                                        │
     │   ──── WIM 이벤트 (SCAN_COMPLETED) ────►│
     │                                        │
     │                                        ├─► nrc_wim_rx()
     │                                        ├─► 이벤트 타입 처리
     │                                        └─► mac80211 알림
```

### 4.3 주요 WIM 명령어와 그 플로우

```
스테이션 연결 플로우:
========================

1. nrc_wim_set_sta_type()
   ├─► WIM_CMD_SET + WIM_TLV_STA_TYPE
   └─► 디바이스를 STA/AP/Mesh로 설정

2. nrc_wim_set_mac_addr()
   ├─► WIM_CMD_SET + WIM_TLV_MACADDR
   └─► 인터페이스 MAC 주소 설정

3. nrc_wim_install_key()
   ├─► WIM_CMD_SET_KEY + WIM_TLV_KEY_PARAM
   └─► 암호화 키 설치

4. nrc_wim_change_sta()
   ├─► WIM_CMD_STA_CMD + 스테이션 파라미터
   └─► 스테이션 추가/제거/수정

스캔 플로우:
=============

1. nrc_wim_hw_scan()
   ├─► WIM_CMD_SCAN_START
   ├─► WIM_TLV_SCAN_PARAM (채널, SSID)
   ├─► WIM_TLV_SCAN_BAND_IE (밴드별 IE)
   └─► WIM_TLV_SCAN_PROBE_REQ_IE (probe request IE)

2. 타겟에서 스캔 수행
   └─► 다중 WIM_EVENT_SCAN_COMPLETED 이벤트

3. 스캔 완료
   └─► 스캔 결과가 포함된 최종 이벤트
```

## 5. Netlink 통신 아키텍처

### 5.1 커널-사용자 공간 통신

```
┌─────────────────────────────────────────────────────────────┐
│                    사용자 공간                              │
├─────────────────────────────────────────────────────────────┤
│  CLI 애플리케이션        Python 테스트 스크립트             │
│  ├─ cli_netlink.c      ├─ nrcnetlink.py                     │
│  ├─ netlink_send_data  ├─ shell.py                          │
│  └─ 명령 파싱          └─ 테스트 자동화                     │
├─────────────────────────────────────────────────────────────┤
│                 Netlink 소켓 레이어                         │
├─────────────────────────────────────────────────────────────┤
│                   커널 공간                                 │
├─────────────────────────────────────────────────────────────┤
│  nrc-netlink.c                                              │
│  ├─ Generic Netlink Family: "NRC-NL-FAM"                   │
│  ├─ 각 NL_* 작업별 명령 핸들러                             │
│  ├─ 멀티캐스트 그룹: WFA_CAPI_RESPONSE, NRC_LOG           │
│  └─ 직접 WIM 명령 변환                                     │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 Netlink 명령 처리 플로우

```
CLI 애플리케이션 예제:
=======================

사용자 명령: cli_app set ampdu_mode 2
     │
     ▼
netlink_send_data(NL_SHELL_RUN, "set ampdu_mode 2")
     │
     ▼ (Netlink 소켓)
커널: nrc_netlink_shell_run()
     │
     ├─► 명령 문자열 파싱
     ├─► 파라미터 검증
     ├─► WIM 명령으로 변환:
     │   └─► WIM_CMD_SET + WIM_TLV_AMPDU_MODE
     ├─► nrc_xmit_wim_request_wait()
     └─► 사용자 공간으로 응답 반환

Python 스크립트 예제:
=====================

halow_ampdu.py 호출:
     │
     ▼
nrcnetlink.send_msg(NL_WFA_CAPI_SEND_ADDBA, params)
     │
     ▼ (Netlink 소켓)
커널: nrc_netlink_send_addba()
     │
     ├─► TID, 대상 MAC 추출
     ├─► 타겟 스테이션 찾기
     ├─► nrc_wim_ampdu_action() 호출
     │   └─► WIM_CMD_AMPDU_ACTION + 파라미터
     └─► 타겟으로 Block ACK 요청 전송
```

### 5.3 Netlink 메시지 카테고리

```
테스트/디버그 명령:
======================
• NL_SHELL_RUN → 직접 펌웨어 셸 명령
• NL_SHELL_RUN_RAW → 원시 명령 실행
• NL_MIC_SCAN → MIC 실패 테스트
• NL_FRAME_INJECTION → 커스텀 프레임 주입

WFA CAPI 명령:
==================
• NL_WFA_CAPI_STA_GET_INFO → 스테이션 정보
• NL_WFA_CAPI_STA_SET_11N → 802.11n 설정
• NL_WFA_CAPI_SEND_ADDBA → Block ACK 설정
• NL_WFA_CAPI_SEND_DELBA → Block ACK 해제
• NL_WFA_CAPI_BSS_MAX_IDLE → Keep-alive 설정

HaLow 특화 명령:
=======================
• NL_HALOW_SET_DUT → Device Under Test 모드
• NL_CLI_APP_GET_INFO → 드라이버 정보
• NL_AUTO_BA_TOGGLE → 자동 Block ACK 제어
```

## 6. 하드웨어 인터페이스 (CSPI) 세부사항

### 6.1 CSPI 레지스터 맵 및 동작

```
CSPI 레지스터 레이아웃:
====================

┌─ 시스템 레지스터 (0x0-0xF) ─────────────────────────────────┐
│ 0x0: C_SPI_WAKE_UP        │ 0x1: C_SPI_DEVICE_STATUS       │
│ 0x2: C_SPI_CHIP_ID_HIGH   │ 0x3: C_SPI_CHIP_ID_LOW         │
│ 0x4: C_SPI_MODEM_ID       │ 0x8: C_SPI_SOFTWARE_VERSION    │
│ 0xC: C_SPI_BOARD_ID       │                                 │
├─ IRQ 제어 (0x10-0x13) ──────────────────────────────────────┤
│ 0x10: C_SPI_EIRQ_MODE     │ 0x11: C_SPI_EIRQ_ENABLE        │
│ 0x12: C_SPI_EIRQ_STATUS_LATCH │ 0x13: C_SPI_EIRQ_STATUS   │
├─ 큐 상태 (0x14-0x1F) ───────────────────────────────────────┤
│ 0x14: C_SPI_QUEUE_STATUS  │ (TX/RX 큐 정보 포함)           │
├─ 메시지 인터페이스 (0x20-0x2F) ─────────────────────────────┤
│ 0x20: C_SPI_MESSAGE       │ (데이터 전송 레지스터)         │
├─ 큐 설정 (0x30-0x41) ───────────────────────────────────────┤
│ 0x30: C_SPI_RXQ_THRESHOLD │ 0x31: C_SPI_RXQ_WINDOW         │
│ 0x40: C_SPI_TXQ_THRESHOLD │ 0x41: C_SPI_TXQ_WINDOW         │
└──────────────────────────────────────────────────────────────┘
```

### 6.2 CSPI 통신 플로우

```
초기화 시퀀스:
=======================

nrc_hif_cspi_init()
     │
     ├─► SPI 버스 파라미터 설정
     ├─► 인터럽트용 GPIO 설정
     ├─► IRQ 핸들러 등록
     │
     ├─► 디바이스 검출:
     │   ├─► C_SPI_CHIP_ID 읽기 → NRC7292 확인
     │   ├─► C_SPI_MODEM_ID 읽기 → 모뎀 타입 확인
     │   └─► C_SPI_SOFTWARE_VERSION 읽기
     │
     ├─► EIRQ 설정:
     │   ├─► C_SPI_EIRQ_MODE = CSPI_EIRQ_MODE 설정
     │   └─► C_SPI_EIRQ_ENABLE = CSPI_EIRQ_A_ENABLE 설정
     │
     └─► 메시지 처리용 RX 스레드 시작

데이터 전송:
==================

nrc_hif_xmit(skb)
     │
     ├─► 디바이스 준비 상태 확인
     ├─► SPI 락 획득
     │
     ├─► 메시지 쓰기:
     │   ├─► 메시지 길이 계산
     │   ├─► C_SPI_MESSAGE 레지스터에 쓰기
     │   └─► 필요시 청크 전송 처리
     │
     ├─► TX 큐 카운터 업데이트
     └─► SPI 락 해제

IRQ 기반 수신:
====================

GPIO IRQ → cspi_irq_handler()
     │
     ├─► C_SPI_EIRQ_STATUS 읽기
     ├─► RX 큐 인터럽트 확인
     │
     ├─► RX 데이터 사용 가능한 경우:
     │   ├─► C_SPI_QUEUE_STATUS 읽기
     │   ├─► 메시지 길이 계산
     │   ├─► C_SPI_MESSAGE에서 읽기
     │   └─► 처리용 큐에 추가
     │
     ├─► 디바이스 상태 변경 확인
     └─► 인터럽트 상태 클리어
```

### 6.3 크레딧 기반 플로우 제어

```
TX 크레딧 관리:
====================

AC별 크레딧 추적:
┌─────────────────────────────────────────────────────────┐
│ atomic_t tx_credit[IEEE80211_NUM_ACS*3]:               │
│ • AC0 (BK): CREDIT_AC0 = 4 크레딧                      │
│ • AC1 (BE): CREDIT_AC1 = 40 크레딧 (또는 20/80 변형)   │
│ • AC2 (VI): CREDIT_AC2 = 8 크레딧                      │
│ • AC3 (VO): CREDIT_AC3 = 8 크레딧                      │
└─────────────────────────────────────────────────────────┘

크레딧 플로우:
호스트 드라이버                           타겟 펌웨어
     │                                        │
     ├─► 사용 가능한 크레딧 확인              │
     ├─► 크레딧 > 0인 경우:                   │
     │   ├─► 크레딧 카운터 감소               │
     │   └─► 프레임 전송                     │
     │                                        │
     │   ──── HIF 헤더가 있는 프레임 ─────────►│
     │                                        │ 프레임 처리
     │                                        │ 버퍼 소비
     │                                        │
     │◄──── WIM_EVENT_CREDIT_REPORT ─────────│
     │                                        │
     ├─► 크레딧 리포트 파싱                   │
     └─► AC별 크레딧 복원                     │

크레딧 리포트 이벤트 구조:
┌─────────────────────────────────────────────────────────┐
│ WIM_EVENT_CREDIT_REPORT                                 │
│ ├─► WIM_TLV_AC_CREDIT_REPORT                           │
│     ├─► AC0 완료된 프레임 개수                          │
│     ├─► AC1 완료된 프레임 개수                          │
│     ├─► AC2 완료된 프레임 개수                          │
│     └─► AC3 완료된 프레임 개수                          │
└─────────────────────────────────────────────────────────┘
```

## 7. 에러 처리 및 복구

### 7.1 복구 메커니즘

```
펌웨어 복구 플로우:
======================

감지:
├─► 워치독 타임아웃 (TARGET_NOTI_WDT_EXPIRED)
├─► 통신 실패
├─► Netlink 복구 명령 (NL_CMD_RECOVERY)
└─► 수동 복구 트리거

복구 프로세스:
nrc_netlink_trigger_recovery()
     │
     ├─► 드라이버 상태를 복구 모드로 설정
     ├─► 모든 TX 큐 중지
     ├─► 대기 중인 작업 플러시
     │
     ├─► 하드웨어 인터페이스 리셋:
     │   ├─► nrc_hif_reset_device()
     │   ├─► IRQ 상태 클리어
     │   └─► CSPI 레지스터 재초기화
     │
     ├─► 펌웨어 재로드:
     │   ├─► WIM_CMD_REQ_FW
     │   └─► WIM_EVENT_READY 대기
     │
     ├─► 설정 복원:
     │   ├─► VIF 설정
     │   ├─► 스테이션 파라미터
     │   ├─► 보안 키
     │   └─► 채널 설정
     │
     └─► 정상 동작 재개
```

### 7.2 전력 관리 통합

```
절전 플로우:
===============

호스트 개시 슬립:
nrc_hif_sleep_target_prepare()
     │
     ├─► TX tasklet 중지
     ├─► 대기 중인 프레임 플러시
     ├─► WIM_CMD_SLEEP 전송
     │   └─► WIM_TLV_SLEEP_DURATION
     │
     ├─► WIM_EVENT_PS_READY 대기
     ├─► CSPI 인터럽트 일시 중단
     └─► 저전력 상태 진입

타겟 개시 웨이크업:
GPIO IRQ (디바이스 준비 신호)
     │
     ├─► nrc_hif_wake_target()
     ├─► C_SPI_DEVICE_STATUS 확인
     ├─► TARGET_NOTI_FW_READY_FROM_PS 처리
     ├─► CSPI 동작 재개
     └─► TX tasklet 재시작
```

## 결론

NRC7292 드라이버는 관심사의 명확한 분리를 통한 정교한 계층화 아키텍처를 구현합니다:

1. **mac80211 인터페이스 레이어**: 표준 Linux 무선 인터페이스 제공
2. **TRX 핸들러 레이어**: 설정 가능한 핸들러 체인으로 패킷 처리 관리  
3. **WIM 프로토콜 레이어**: 명령/응답/이벤트 통신 구현
4. **HIF 레이어**: 플러그 가능한 인터페이스로 하드웨어 추상화 제공
5. **CSPI 레이어**: NRC7292 칩과의 저수준 SPI 통신 처리

이 설계는 다음을 가능하게 합니다:
- **모듈화**: 각 레이어는 잘 정의된 인터페이스를 가짐
- **확장성**: 핸들러 체인이 기능 추가를 허용
- **안정성**: 크레딧 기반 플로우 제어 및 복구 메커니즘
- **테스트 가능성**: Netlink 인터페이스로 포괄적 테스트 가능
- **전력 효율성**: 펌웨어 조정과 통합된 전력 관리

이 아키텍처는 표준 Linux 네트워킹 도구와의 호환성을 유지하면서 STA/AP 모드, 메시 네트워킹, 보안 프로토콜, 전력 관리를 포함한 전체 HaLow 작업 범위를 지원합니다.